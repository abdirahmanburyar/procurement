stages:
  - build
  - test
  - docker
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  REGISTRY: $CI_REGISTRY
  IMAGE_PREFIX: $CI_REGISTRY_IMAGE

cache:
  paths:
    - .m2/repository/
    - frontend/node_modules/

build:
  stage: build
  image: maven:3.9-eclipse-temurin-21
  script:
    - mvn clean package -DskipTests
  artifacts:
    paths:
      - "*/target/*.jar"
    expire_in: 1 hour

test:
  stage: test
  image: maven:3.9-eclipse-temurin-21
  script:
    - mvn test
  coverage: '/Total.*?([0-9]{1,3})%/'

build-frontend:
  stage: build
  image: node:18-alpine
  script:
    - cd frontend
    - npm ci
    - npm run build
  artifacts:
    paths:
      - frontend/dist
    expire_in: 1 hour

docker-build:
  stage: docker
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - |
      docker build -f eureka-server/Dockerfile -t $IMAGE_PREFIX-eureka-server:$CI_COMMIT_SHA .
      docker build -f config-server/Dockerfile -t $IMAGE_PREFIX-config-server:$CI_COMMIT_SHA .
      docker build -f api-gateway/Dockerfile -t $IMAGE_PREFIX-api-gateway:$CI_COMMIT_SHA .
      docker build -f auth-service/Dockerfile -t $IMAGE_PREFIX-auth-service:$CI_COMMIT_SHA .
      docker build -f procurement-service/Dockerfile -t $IMAGE_PREFIX-procurement-service:$CI_COMMIT_SHA .
      docker build -f quotation-service/Dockerfile -t $IMAGE_PREFIX-quotation-service:$CI_COMMIT_SHA .
      docker build -f purchase-order-service/Dockerfile -t $IMAGE_PREFIX-purchase-order-service:$CI_COMMIT_SHA .
      docker build -f inventory-service/Dockerfile -t $IMAGE_PREFIX-inventory-service:$CI_COMMIT_SHA .
      docker build -f frontend/Dockerfile -t $IMAGE_PREFIX-frontend:$CI_COMMIT_SHA ./frontend
    - |
      docker push $IMAGE_PREFIX-eureka-server:$CI_COMMIT_SHA
      docker push $IMAGE_PREFIX-config-server:$CI_COMMIT_SHA
      docker push $IMAGE_PREFIX-api-gateway:$CI_COMMIT_SHA
      docker push $IMAGE_PREFIX-auth-service:$CI_COMMIT_SHA
      docker push $IMAGE_PREFIX-procurement-service:$CI_COMMIT_SHA
      docker push $IMAGE_PREFIX-quotation-service:$CI_COMMIT_SHA
      docker push $IMAGE_PREFIX-purchase-order-service:$CI_COMMIT_SHA
      docker push $IMAGE_PREFIX-inventory-service:$CI_COMMIT_SHA
      docker push $IMAGE_PREFIX-frontend:$CI_COMMIT_SHA
  only:
    - main
    - develop

deploy:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - kubectl create namespace procurement --dry-run=client -o yaml | kubectl apply -f -
    - kubectl apply -f k8s/postgresql/ -n procurement
    - kubectl wait --for=condition=ready pod -l app=postgresql -n procurement --timeout=300s || true
    - kubectl apply -f k8s/config/ -n procurement
    - |
      # Update image tags in manifests
      find k8s/services -name "*.yaml" -exec sed -i "s|:latest|:$CI_COMMIT_SHA|g" {} \;
      find k8s/services -name "*.yaml" -exec sed -i "s|ghcr.io/YOUR_USERNAME|$IMAGE_PREFIX|g" {} \;
    - kubectl apply -f k8s/services/ -n procurement
    - kubectl apply -f k8s/ingress/ -n procurement
  environment:
    name: production
  only:
    - main
  when: manual

